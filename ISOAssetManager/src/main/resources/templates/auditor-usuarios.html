<!DOCTYPE html>
<!-- Namespace de Thymeleaf y Spring Security para control de acceso en la vista -->
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="es">

<head>
    <meta charset="UTF-8">
    <title>Gestión de Clientes - Auditor</title>
    <link rel="stylesheet" th:href="@{/usuariosestilos.css}">
</head>

<body>
    <div class="container">

        <!-- Navegación: Botón de volver condicional según el rol del usuario -->
        <div class="header-actions">
            <a sec:authorize="hasAnyRole('ADMIN','AUDITOR')"
                th:href="@{${#authentication.principal.authorities.![authority].contains('ROLE_ADMIN') ? '/panel-admin' : '/panel-auditor'}}"
                class="btn-back">
                ← Volver
            </a>
        </div>

        <h2>Gestión de Clientes</h2>

        <!-- Bloques para mostrar mensajes de éxito o error si existen en el modelo -->
        <div th:if="${ok}" class="alert success" th:text="${ok}"></div>
        <div th:if="${error}" class="alert danger" th:text="${error}"></div>

        <!-- Tabla de usuarios/clientes -->
        <table>
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Empresa asignada</th>
                    <th>Departamento asignado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <!-- Itera sobre la lista de usuarios -->
                <tr th:each="u : ${usuarios}">
                    <td th:text="${u.nombre}">Nombre Cliente</td>
                    <td th:text="${u.email}">correo@ejemplo.com</td>
                    <!-- Muestra información de empresa/departamento o un mensaje por defecto -->
                    <td th:text="${u.empresa != null ? u.empresa.nombre : 'Sin asignar'}">Empresa</td>
                    <td th:text="${u.departamento != null ? u.departamento.descripcion : 'Sin asignar'}">Departamento
                    </td>
                    <td>
                        <!-- Formulario para asignar una empresa al usuario -->
                        <form th:action="@{|/auditor/usuarios/${u.id}/asignar-empresa|}" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <select name="empresaId" required>
                                <option value="" disabled selected>Selecciona empresa</option>
                                <option th:each="e : ${empresas}" th:value="${e.id}" th:text="${e.nombre}"></option>
                            </select>
                            <button type="submit">Asignar empresa</button>
                        </form>

                        <!-- Formulario para asignar un departamento (solo visible si tiene empresa asignada) -->
                        <form th:if="${u.empresa != null}"
                            th:action="@{|/auditor/usuarios/${u.id}/asignar-departamento|}" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                            <input type="text" name="departamentoNombre" placeholder="Nombre del departamento"
                                required />

                            <button type="submit">Asignar departamento</button>
                        </form>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</body>

</html>